{"version":3,"sources":["../../src/parsers/html.js"],"names":["utils","require","cheerio","_","db","instance","Html","result","Promise","resolve","reject","parent","$","each","root","elem","recursive_element","parent_file","tag","get","tagName","value","name","type","current","key","attr","undefined","correctedPath","correctPathSync","candidate","findWhere","getIdentifiedFiles","addRelations","from","to","id","relationship","cluster","children","length","contains","addProperty","visibility","classId","addClass","fill","file","getClass","child","then","read_node","parse_dom","find_html_elements","catch","console","log","error","node","data","load","module","exports"],"mappings":";;;;;;AACA,IAAIA,QAAQC,QAAQ,gBAAR,CAAZ;AACA,IAAIC,UAAUD,QAAQ,SAAR,CAAd;AACA,IAAIE,IAAIF,QAAQ,YAAR,EAAsBE,CAA9B;AACA,IAAIC,KAAKH,QAAQ,iBAAR,CAAT;;AAEA,IAAII,WAAW,IAAf;;IAEMC,I;AACE,wBAAc;AAAA;;AACN,oBAAI,CAACD,QAAL,EAAe;AACPA,mCAAW,IAAX;AACP;;AAED,uBAAOA,QAAP;AACP;;;;mDAGkBE,M,EAAQ;AACnB,+BAAO,IAAIC,OAAJ,CACC,UAAUC,OAAV,EAAmBC,MAAnB,EAA2B;AACnB,oCAAIC,SAASJ,OAAO,CAAP,CAAb;AACA,oCAAIK,IAAIL,OAAO,CAAP,CAAR;;AAGAJ,kCAAEU,IAAF,CAAOD,EAAEE,IAAF,EAAP,EAAiB,UAAUC,IAAV,EAAgB;AACzBV,iDAASW,iBAAT,CAA2BJ,CAA3B,EAA8BG,IAA9B,EAAoC,IAApC,EAA0CJ,MAA1C;AACP,iCAFD;;AAIAF;AAEP,yBAZF,CAAP;AAaP;;;kDACiBG,C,EAAGG,I,EAAMJ,M,EAAQM,W,EAAa;;AAExC,4BAAIC,MAAMN,EAAEG,IAAF,EAAQI,GAAR,CAAY,CAAZ,EAAeC,OAAzB;AACA,4BAAIC,cAAJ;AACA,4BAAIC,OAAO,EAAX;AACA,4BAAIC,OAAOL,GAAX;AACA,4BAAIM,UAAUP,YAAYQ,GAA1B;AACA,4BAAId,WAAW,IAAf,EAAqB;AACba,0CAAUb,OAAOc,GAAjB;AACP;;AAED,4BAAIP,QAAQ,QAAZ,EAAsB;AACd,oCAAIN,EAAEG,IAAF,EAAQW,IAAR,CAAa,KAAb,MAAwBC,SAA5B,EAAuC;AAC/B,4CAAIC,gBAAgB5B,MAAM6B,eAAN,CAAsBjB,EAAEG,IAAF,EAAQW,IAAR,CAAa,KAAb,CAAtB,EAA2CT,YAAYK,IAAvD,EAA6D,KAA7D,CAApB;AACA,4CAAIQ,YAAY3B,EAAE4B,SAAF,CAAY3B,GAAG4B,kBAAH,EAAZ,EAAqC,EAAEV,MAAMM,aAAR,EAArC,CAAhB;AACA,4CAAIE,cAAcH,SAAlB,EAA6B;AACrBvB,mDAAG6B,YAAH,CAAgB,EAAEC,MAAMjB,YAAYQ,GAApB,EAAyBU,IAAIL,UAAUM,EAAvC,EAA2CC,cAAc,EAAzD,EAA6DC,SAAS,IAAtE,EAAhB;AACP;AACR;AACR;;AAGD,4BAAIpB,QAAQ,MAAZ,EAAoB;AACZ,oCAAIN,EAAEG,IAAF,EAAQW,IAAR,CAAa,MAAb,MAAyBC,SAA7B,EAAwC;AAChC,4CAAIC,iBAAgB5B,MAAM6B,eAAN,CAAsBjB,EAAEG,IAAF,EAAQW,IAAR,CAAa,MAAb,CAAtB,EAA4CT,YAAYK,IAAxD,CAApB;;AAEA,4CAAIQ,aAAY3B,EAAE4B,SAAF,CAAY3B,GAAG4B,kBAAH,EAAZ,EAAqC,EAAEV,MAAMM,cAAR,EAArC,CAAhB;AACA,4CAAIE,eAAcH,SAAlB,EAA6B;AACrBvB,mDAAG6B,YAAH,CAAgB,EAAEC,MAAMjB,YAAYQ,GAApB,EAAyBU,IAAIL,WAAUM,EAAvC,EAA2CC,cAAc,EAAzD,EAA6DC,SAAS,IAAtE,EAAhB;AACP;AACR;AACR;;AAED,4BAAI1B,EAAEG,IAAF,EAAQwB,QAAR,GAAmBC,MAAnB,KAA8B,CAAlC,EAAqC;AAC7BlB,uCAAOJ,GAAP;;AAEA,oCAAIN,EAAEG,IAAF,EAAQW,IAAR,CAAa,IAAb,MAAuBC,SAA3B,EAAsC;AAC9BL,+CAAOV,EAAEG,IAAF,EAAQW,IAAR,CAAa,IAAb,CAAP;AACP;;AAED,oCAAIvB,EAAEsC,QAAF,CAAW,CAAC,MAAD,EAAS,GAAT,EAAc,KAAd,CAAX,EAAiCvB,GAAjC,CAAJ,EAA2C;AACnCG,gDAAQT,EAAEG,IAAF,EAAQW,IAAR,CAAa,MAAb,CAAR;AACP;;AAED,oCAAIR,QAAQ,QAAZ,EAAsB;AACdG,gDAAQT,EAAEG,IAAF,EAAQW,IAAR,CAAa,KAAb,CAAR;AACP;;AAED,oCAAIR,QAAQ,GAAZ,EAAiB;AACTI,+CAAO,MAAP;AACP;;AAEDlB,mCAAGsC,WAAH,CAAelB,OAAf,EAAwB,EAAEF,MAAMA,IAAR,EAAcD,OAAOA,KAArB,EAA4BE,MAAMA,IAAlC,EAAwCoB,YAAY,GAApD,EAAxB;AACP,yBApBD,MAqBK;AACG,oCAAIC,UAAUxC,GAAGyC,QAAH,CAAY,EAAEvB,MAAMA,IAAR,EAAcwB,MAAM,MAApB,EAA4BvB,MAAMA,IAAlC,EAAwCwB,MAAM9B,YAAYK,IAA1D,EAAgEgB,SAASrB,YAAYqB,OAArF,EAAZ,CAAd;AACAlC,mCAAG6B,YAAH,CAAgB,EAAEC,MAAMV,OAAR,EAAiBW,IAAIS,OAArB,EAA8BP,cAAc,aAA5C,EAAhB;AACAb,0CAAUoB,OAAV;AACAjC,yCAASP,GAAG4C,QAAH,CAAYJ,OAAZ,CAAT;AACP;;AAED,4BAAIhC,EAAEG,IAAF,EAAQwB,QAAR,GAAmBC,MAAnB,GAA4B,CAAhC,EAAmC;AAC3BrC,kCAAEU,IAAF,CAAOD,EAAEG,IAAF,EAAQwB,QAAR,EAAP,EAA2B,UAAUU,KAAV,EAAiB;AACpC5C,iDAASW,iBAAT,CAA2BJ,CAA3B,EAA8BqC,KAA9B,EAAqCtC,MAArC,EAA6CM,WAA7C;AACP,iCAFD;AAIP;AAER;;;+CACc8B,I,EAAM;AACb,+BAAO,IAAIvC,OAAJ,CACC,UAAUC,OAAV,EAAmBC,MAAnB,EAA2B;AACnBF,wCAAQC,OAAR,CAAgBsC,IAAhB,EACSG,IADT,CACclD,MAAMmD,SADpB,EAESD,IAFT,CAEc7C,SAAS+C,SAFvB,EAGSF,IAHT,CAGc7C,SAASgD,kBAHvB,EAISC,KAJT,CAIe,iBAAS;AAAEC,gDAAQC,GAAR,CAAY,KAAZ,EAAmBC,KAAnB;AAA4B,iCAJtD,EAKSP,IALT,CAKc,YAAY;AACVzC;AACP,iCAPT;AASP,yBAXF,CAAP;AAYP;;;0CACSF,M,EAAQ;AACV,+BAAO,IAAIC,OAAJ,CACC,UAAUC,OAAV,EAAmBC,MAAnB,EAA2B;AACnB,oCAAIgD,OAAOnD,OAAO,CAAP,CAAX;AACA,oCAAIoD,OAAOpD,OAAO,CAAP,CAAX;AACA,oCAAIK,IAAIV,QAAQ0D,IAAR,CAAaD,IAAb,CAAR;AACAlD,wCAAQ,CAACiD,IAAD,EAAO9C,CAAP,CAAR;AAEP,yBAPF,CAAP;AAQP;;;;;;AAITiD,OAAOC,OAAP,GAAiB,IAAIxD,IAAJ,EAAjB","file":"html.js","sourcesContent":["\nvar utils = require(\"../utils/utils\");\nvar cheerio = require('cheerio');\nvar _ = require('underscore')._;\nvar db = require(\"../lib/database\");\n\nlet instance = null;\n\nclass Html {\n        constructor() {\n                if (!instance) {\n                        instance = this;\n                }\n\n                return instance;\n        }\n\n\n        find_html_elements(result) {\n                return new Promise(\n                        function (resolve, reject) {\n                                let parent = result[0];\n                                let $ = result[1];\n\n\n                                _.each($.root(), function (elem) {\n                                        instance.recursive_element($, elem, null, parent);\n                                });\n\n                                resolve();\n\n                        });\n        }\n        recursive_element($, elem, parent, parent_file) {\n\n                let tag = $(elem).get(0).tagName;\n                let value;\n                let name = \"\";\n                let type = tag;\n                let current = parent_file.key;\n                if (parent !== null) {\n                        current = parent.key;\n                }\n\n                if (tag === \"script\") {\n                        if ($(elem).attr(\"src\") !== undefined) {\n                                let correctedPath = utils.correctPathSync($(elem).attr(\"src\"), parent_file.name, \".js\");\n                                let candidate = _.findWhere(db.getIdentifiedFiles(), { name: correctedPath });\n                                if (candidate !== undefined) {\n                                        db.addRelations({ from: parent_file.key, to: candidate.id, relationship: \"\", cluster: true });\n                                }\n                        }\n                }\n\n\n                if (tag === \"link\") {\n                        if ($(elem).attr(\"href\") !== undefined) {\n                                let correctedPath = utils.correctPathSync($(elem).attr(\"href\"), parent_file.name);\n\n                                let candidate = _.findWhere(db.getIdentifiedFiles(), { name: correctedPath });\n                                if (candidate !== undefined) {\n                                        db.addRelations({ from: parent_file.key, to: candidate.id, relationship: \"\", cluster: true });\n                                }\n                        }\n                }\n\n                if ($(elem).children().length === 0) {\n                        name = tag;\n\n                        if ($(elem).attr(\"id\") !== undefined) {\n                                name = $(elem).attr(\"id\");\n                        }\n\n                        if (_.contains(['link', 'a', 'ddd'], tag)) {\n                                value = $(elem).attr(\"href\")\n                        }\n\n                        if (tag === \"script\") {\n                                value = $(elem).attr(\"src\")\n                        }\n\n                        if (tag === \"a\") {\n                                name = \"link\"\n                        }\n\n                        db.addProperty(current, { name: name, value: value, type: type, visibility: \"+\" });\n                }\n                else {\n                        let classId = db.addClass({ name: name, fill: \"pink\", type: type, file: parent_file.name, cluster: parent_file.cluster });\n                        db.addRelations({ from: current, to: classId, relationship: \"composition\" });\n                        current = classId;\n                        parent = db.getClass(classId);\n                }\n\n                if ($(elem).children().length > 0) {\n                        _.each($(elem).children(), function (child) {\n                                instance.recursive_element($, child, parent, parent_file);\n                        });\n\n                }\n\n        }\n        operation_html(file) {\n                return new Promise(\n                        function (resolve, reject) {\n                                Promise.resolve(file)\n                                        .then(utils.read_node)\n                                        .then(instance.parse_dom)\n                                        .then(instance.find_html_elements)\n                                        .catch(error => { console.log(\"err\", error); })\n                                        .then(function () {\n                                                resolve();\n                                        });\n\n                        });\n        }\n        parse_dom(result) {\n                return new Promise(\n                        function (resolve, reject) {\n                                let node = result[0];\n                                let data = result[1];\n                                let $ = cheerio.load(data);\n                                resolve([node, $]);\n\n                        });\n        }\n\n}\n\nmodule.exports = new Html();"]}